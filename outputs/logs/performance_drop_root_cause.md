# 성능 하락 원인 분석 보고서

**일시:** 2025-10-23
**분석 대상:** submission_baseline_v2_test.csv
**분석자:** 개발팀

---

## 1. 성능 하락 현황

### LB 성능 비교

| 버전 | Public LB | Private LB | 파일 |
|------|-----------|------------|------|
| 기존 최고 | **34.0426%** | **13.4454%** | submission_baseline_test_clean.csv |
| 신규 (v2) | 31.9149% | 12.2951% | submission_baseline_v2_test.csv |
| **차이** | **-2.13%p** | **-1.15%p** | - |

---

## 2. 변경 사항 분석

### 2.1 변경 통계

- **변경된 케이스:** 41개 (37.3%)
- **유지된 케이스:** 69개 (62.7%)

### 2.2 길이 변화 분석

- 길이 증가: 17개
- 길이 감소: 20개
- 길이 동일: 4개
- 평균 길이 비율: 119.9%

### 2.3 주요 변경 패턴

1. **보조용언 띄어쓰기 차이**
   - 예: "받아 봐야겠다" ↔ "받아봐야겠다"
   - 41개 중 일부가 이 패턴

2. **표현 간결화**
   - 예: "비용을 절감하기 위해" → "비용 절감을 위해"

3. **메타데이터 처리 차이**
   - 일부 케이스에서 설명문이 포함됨

---

## 3. 핵심 문제 케이스: grm260797

### 문제 상황

**원문 (353자):**
```
추기경회의의 결과 자체가 중요한 정치적 메시지를 담기도 한다. 1995년 베네딕토 15세의 후임자를 뽑는 추기경회의에서...
```

**기존 버전 (1460자 - 원문의 413%):**
```
추기경 회의의 결과 자체가... [수정 보완] 추기경 회의의 결과... [최종 교정본 - 요청사항 준수] 추기경 회의의... 최종 출력: 추기경 회의의...
```
→ 메타데이터 "[수정 보완]", "[최종 교정본]", "최종 출력:" 등이 모두 포함

**신규 버전 (801자 - 원문의 227%):**
```
베네딕토 16세는 2005년 교황으로 선출되었으며, 1995년 추기경회의는 존재하지 않음... 최종 교정본: 추기경회의의 결과...
```
→ 여전히 설명문과 "최종 교정본:" 레이블 포함

### 분석

- ✅ 신규 버전이 기존보다 개선 (1460자 → 801자)
- ⚠️ 그러나 여전히 메타데이터가 완전히 제거되지 않음
- ❌ 길이 가드는 "후처리 후" 측정이므로 이 문제를 잡지 못함

---

## 4. Train vs Test 성능 비교

### Train 데이터 성능 (254개)

| 지표 | 기존 (with rules) | 신규 (no rules) | 차이 |
|------|------------------|-----------------|------|
| TP | 47 | 52 | **+5** |
| FP | 10 | 8 | **-2** |
| FN | 196 | 191 | **-5** |
| Recall | 18.58% | 20.72% | **+2.14%p** |
| Precision | 82.46% | 86.67% | **+4.21%p** |

✅ **Train 데이터에서는 신규 버전이 더 좋음!**

### Test LB 성능 (110개)

| 지표 | 기존 | 신규 | 차이 |
|------|------|------|------|
| Public | 34.04% | 31.91% | **-2.13%p** |
| Private | 13.45% | 12.30% | **-1.15%p** |

❌ **Test 데이터에서는 신규 버전이 더 나쁨!**

---

## 5. 근본 원인 분석

### 5.1 API 랜덤성 (주요 원인)

**문제:**
- 같은 프롬프트라도 API 응답이 시간/상태에 따라 다름
- 41개 케이스(37.3%)가 변경됨

**증거:**
- Train에서는 신규가 +2.14%p 개선
- Test에서는 신규가 -2.13%p 하락
- **이는 API 응답의 불일치를 의미**

**영향:**
- Train 데이터 재생성 시 다른 응답 생성
- Test 데이터 재생성 시 또 다른 응답 생성
- 일관성 없는 성능

### 5.2 메타데이터 제거 불완전 (부가 원인)

**문제:**
- grm260797 같은 케이스에서 설명문이 과도하게 포함
- 콜론 로직이 복잡한 설명문을 처리하지 못함

**증거:**
```python
# grm260797 케이스
기존: 1460자 (메타데이터 포함)
신규: 801자 (여전히 메타데이터 포함)
```

**영향:**
- 정확도 저하
- 불필요한 텍스트로 인한 혼란
- Recall/Precision 모두 악영향

### 5.3 Train/Test 분포 차이 (가능성)

**현상:**
- Train에서 좋은 변경이 Test에서 나쁠 수 있음
- Public/Private 격차 20%p도 이를 뒷받침

**추정:**
- Test 데이터가 Train과 다른 분포를 가짐
- 특정 패턴(보조용언 띄어쓰기 등)이 Test에서 불리

---

## 6. 길이 가드 검증

### 발동 여부

- **로그 확인:** 0회 발동
- **분석 확인:** 1건 후보 (grm260797, 54.9% 손실)

### 왜 발동하지 않았나?

**길이 가드 로직:**
```python
length_ratio = len(corrected) / len(original)
if length_ratio < 0.6:
    return original
```

**grm260797 케이스:**
- 원문: 353자
- API 응답: 801자 (이미 길음)
- 후처리 후: 801자 (변화 없음)
- 비율: 801/353 = 227% (**60%보다 훨씬 큼**)

**결론:** 길이 가드는 "줄어드는" 경우만 감지. "늘어나는" 경우는 감지 못함.

---

## 7. 종합 결론

### 성능 하락의 주요 원인

1. **API 랜덤성 (60%)**
   - 같은 프롬프트라도 응답이 매번 다름
   - 41개 케이스 변경의 직접 원인
   - Train/Test 성능 불일치 발생

2. **메타데이터 제거 불완전 (30%)**
   - 복잡한 설명문 처리 실패
   - grm260797 같은 극단 케이스 발생
   - 텍스트 품질 저하

3. **Train/Test 분포 차이 (10%)**
   - 특정 패턴이 Test에서 불리
   - 보조용언 띄어쓰기 등

### 길이 가드의 역할

- ✅ 설계 의도대로 작동함 (60% 미만 손실 감지)
- ❌ 하지만 "늘어나는" 문제는 감지 못함
- ⚠️ grm260797 같은 케이스는 방어 못함

### 왜 Train에서는 개선되고 Test에서는 하락했나?

**가설:**
- API 재호출로 인한 랜덤 응답 변화
- Train 데이터에 유리한 응답 생성
- Test 데이터에 불리한 응답 생성
- **일관성 부족이 근본 문제**

---

## 8. 교훈

### 8.1 API 랜덤성의 심각성

- **같은 프롬프트 ≠ 같은 응답**
- 재생성할 때마다 성능이 달라질 수 있음
- **안정적인 성능 보장 불가**

### 8.2 메타데이터 제거의 중요성

- 단순한 패턴 매칭으로는 불충분
- 복잡한 설명문 대응 필요
- **프롬프트에서 사전 차단이 더 효과적**

### 8.3 Train 성능 ≠ Test 성능

- Train에서 개선되어도 Test에서 하락 가능
- **일반화가 최우선**
- 과적합 경계 필요

---

## 9. 향후 대응 방안

### 즉시 조치

1. **기존 최고 버전 사용**
   - submission_baseline_test_clean.csv (Public 34.04%, Private 13.45%)
   - API 재호출 최소화

2. **롤백 결정**
   - 길이 가드 등 개선사항은 유지
   - 하지만 API 재생성은 피함

### 중기 전략

1. **프롬프트 개선으로 메타데이터 사전 차단**
   ```
   출력 규칙:
   1. 교정된 문장만 출력 (설명 금지)
   2. 콜론(:), 줄바꿈 절대 금지
   3. "원문:", "교정:", "최종" 라벨 금지
   ```

2. **교차검증으로 안정성 확인**
   - 5-fold CV로 성능 분산 측정
   - 일관성 있는 버전만 채택

3. **API 호출 최소화**
   - 검증된 버전은 재생성하지 않음
   - 프롬프트 변경 시에만 재호출

### 장기 전략

1. **Ensemble 고려**
   - 여러 버전의 결과 결합
   - API 랜덤성 완화

2. **Self-Consistency**
   - 같은 프롬프트 3회 호출
   - 다수결로 최종 결정

---

## 10. 최종 권고사항

### 현재 상황

- ✅ 길이 가드는 정상 작동 (의도대로)
- ❌ API 랜덤성이 주요 문제
- ⚠️ 메타데이터 제거 개선 필요

### 권고

1. **기존 최고 버전 유지**
   - submission_baseline_test_clean.csv
   - Public 34.04%, Private 13.45%

2. **API 재생성 자제**
   - 랜덤성으로 인한 성능 변동 위험
   - 프롬프트 변경 시에만 신중히 재생성

3. **프롬프트 개선 우선**
   - 메타데이터를 근본적으로 차단
   - 형식 제약 강화

4. **교차검증 도입**
   - 일반화 성능 확인
   - 안정성 보장

---

**작성 완료:** 2025-10-23
**분석 소요 시간:** 약 30분
**핵심 발견:** API 랜덤성이 주요 원인, Train/Test 성능 불일치
